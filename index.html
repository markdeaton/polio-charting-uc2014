<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
      on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Global Polio Eradication Initiative</title>
    
    <link rel="stylesheet" href="http://js.arcgis.com/3.9/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.9/js/esri/css/esri.css">
    <style>
      html, body, #mapDiv {
        padding:0;
        margin:0;
        height:100%;
      }

	  #timeInfo {
	  }
      #mapDiv {
        position: relative;
        height: 70%;
      }

      #bottomPanel {
        left: 50%;
        margin: 0 auto;
        margin-left: -500px;
        position: absolute; 
        bottom: 2.5em;
      }

	  #chartThreePlusDose {
		width: 250px; 
		height: 150px; 
		margin: 5px auto 0px auto;
	  }
      #timeInfo{
		visibility: hidden;
		border-radius: 4px;
        border: solid 2px #ccc;
        background-color: #fff;
        display: block;
        padding: 5px;
        position: relative;
        text-align: center;
        width: 1000px;
        z-index: 99;
      }
    </style>

    <script src="http://js.arcgis.com/3.9/"></script>
    <script type="text/javascript" src="res/config.js"></script>
    
    <script>
    var map;
      require([
        "esri/map", 
        "esri/kernel",
        "esri/layers/ArcGISTiledMapServiceLayer",
        "esri/layers/ArcGISDynamicMapServiceLayer",
        "esri/IdentityManager",
        "esri/ServerInfo",
        "esri/geometry/Extent",
        "esri/tasks/IdentifyTask",
        "esri/tasks/IdentifyParameters",
        "esri/TimeExtent", 
        "esri/dijit/TimeSlider",
        "dojo/cookie",
        "dojo/json",
        "dojo/_base/array", 
        "dojo/_base/unload",
        "dojo/dom-style",
        "dijit/layout/BorderContainer",
        "dijit/layout/ContentPane",
		"dojox/charting/Chart",
 		"dojox/charting/themes/Claro",
 		"dojox/charting/plot2d/Columns",
	    "dojox/charting/axis2d/Default",
        "dojo/dom", 
        "dojo/parser",
        "dojo/ready",
        "dojo/domReady!"
      ], function(
        Map, 
        kernel,
        ArcGISTiledMapServiceLayer,
        ArcGISDynamicMapServiceLayer, 
        IdentityManager,
        ServerInfo,
        Extent,
        IdentifyTask,
        IdentifyParameters,
        TimeExtent, 
        TimeSlider,
        cookie,
        JSON,
        arrayUtils,
        baseUnload,
        domStyle,
        BorderContainer,
        ContentPane,
        Chart,
        ChartTheme, 
        Columns,
        ChartDefaultAxes,
        dom,
        parser,
        ready
      ) {
      	var identifyTask, identifyParams;
	 	var chartThreePlusDose, chartZeroDose;
     	var cred = "esri_jsapi_id_manager_data"; // cookie/local storage name
     	
      	ready(function() {
			// store credentials/serverInfos before the page unloads
			baseUnload.addOnUnload(storeCredentials);
			// look for credentials in local storage
			loadCredentials();

     		parser.parse();
      		
	        map = new Map("mapDiv", {
	        		extent: new Extent(config.initialExtent)});
	
	/*
	        var serverInfo = new ServerInfo({
	        	adminTokenServiceUrl:"http://drumlin:6080/arcgis/tokens/",
	        	server:"http://drumlin:6080"
	        });
	        var userInfo = {username:"GPEI", password:"kill.polio"};
	        IdentityManager.generateToken(serverInfo, userInfo).then(function(value) {
	        	var tokne = value;
	        });
	*/
	
	        
	        var basemap = new ArcGISTiledMapServiceLayer(config.services.basemap);
	        // map.addLayer(basemap);
	        
	        // Dose layers - admin polygon level
	        var lyr3Dose = new ArcGISDynamicMapServiceLayer(config.services.ThreePlusDosePct_poly, 
	        				{visible:true});
			// var lyr0Dose = new ArcGISDynamicMapServiceLayer(config.services.ZeroDoesPct_poly, {visible:false});
	/*
	        //apply a definition expression so only some features are shown 
	        var layerDefinitions = [];
	        layerDefinitions[0] = "FIELD_KID=1000148164";
	        opLayer.setLayerDefinitions(layerDefinitions);*/

        	createCharts();
	
	
	        map.addLayers([basemap, lyr3Dose]);
			map.on("click", doIdentify);
	
	        map.on("layers-add-result", function() {
	        	// initSlider();
	        	initIdentify();
	        });
	
	/*
	        function initSlider() {
	          var timeSlider = new TimeSlider({
	            style: "width: 100%;"
	          }, dom.byId("timeSliderDiv"));
	          map.setTimeSlider(timeSlider);
	          
	          var timeExtent = new TimeExtent();
	          timeExtent.startTime = new Date("1/1/1921 UTC");
	          timeExtent.endTime = new Date("12/31/2009 UTC");
	          timeSlider.setThumbCount(2);
	          timeSlider.createTimeStopsByTimeInterval(timeExtent, 2, "esriTimeUnitsYears");
	          timeSlider.setThumbIndexes([0,1]);
	          timeSlider.setThumbMovingRate(2000);
	          timeSlider.startup();
	          
	          //add labels for every other time stop
	          var labels = arrayUtils.map(timeSlider.timeStops, function(timeStop, i) { 
	            if ( i % 2 === 0 ) {
	              return timeStop.getUTCFullYear(); 
	            } else {
	              return "";
	            }
	          }); 
	          
	          timeSlider.setLabels(labels);
	          
	          timeSlider.on("time-extent-change", function(evt) {
	            var startValString = evt.startTime.getUTCFullYear();
	            var endValString = evt.endTime.getUTCFullYear();
	            dom.byId("daterange").innerHTML = "<i>" + startValString + " to " + endValString  + "<\/i>";
	          });
	        }*/
	
			function doIdentify (event) {
	            identifyParams.width = map.width;
	            identifyParams.height = map.height;
				identifyParams.geometry = event.mapPoint;
				identifyParams.mapExtent = map.extent;
	            identifyTask.execute(identifyParams, function (idResults) {
            		// Chart the results
					var ary3DoseChartVals = idResults.map(function(val) {
						return val.feature.attributes["THREE_PLUS_DOSES_PER"];
					});
					// domStyle.set("chartThreePlusDose", {"visibility":"visible"});
					console.log(JSON.stringify(ary3DoseChartVals));
					var ary3DoseChartValsCorrected = ary3DoseChartVals.map(Number);
					console.log(JSON.stringify(ary3DoseChartValsCorrected));
					chartThreePlusDose.updateSeries("seriesThreePlusDose", ary3DoseChartValsCorrected);
					chartThreePlusDose.fullRender();
				});		
			}
			
			function initIdentify() {
	            identifyTask = new IdentifyTask(lyr3Dose.url);
	
	            identifyParams = new IdentifyParameters();
	            identifyParams.tolerance = 1;
	            identifyParams.returnGeometry = false;
	            identifyParams.layerIds = [0];
	            identifyParams.layerOption = IdentifyParameters.LAYER_OPTION_ALL;
			}
	        
	        function createCharts() {
			 
				chartThreePlusDose = new Chart("chartThreePlusDose");
			    // Set the theme
			    chartThreePlusDose.setTheme(ChartTheme);
			 
			    // Add the only/default plot
			    chartThreePlusDose.addPlot("default", {
			        type: Columns,
			        gap: 10
/*
			        hAxis: "x",
			        vAxis: "y",
			        labels: true*/

			        // fill: {color:"tan"}
			    });
			 
			    // Add axes


			    chartThreePlusDose.addAxis("x", {
			    	labels: [
			    		{value:1, text:"P6m"},
			    		{value:2, text:"P6-12m"}
			    	]
			    });
			    chartThreePlusDose.addAxis("y", { 
			    	vertical: true, includeZero: true,  
			    	fixLower: "major", fixUpper: "major", 
			    	min:0, max:100,
			    	title: "3+ Dose Percent"
			    });


			 
			    // Add the series of data
			    chartThreePlusDose.addSeries("seriesThreePlusDose", [], 
			    		{ stroke: {color: "darkgray", width: 2}, 
			        	  fill: "tan"
			       		}	
				);
			    
			    // Add tooltips
			    // var tip = new ChartTooltip(chartThreePlusDose, "default");

                    }

                    function loadCredentials() {
                        var idJson, idObject;

                        if (supports_local_storage()) {
                            // read from local storage
                            idJson = window.localStorage.getItem(cred);
                        } else {
                            // read from a cookie
                            idJson = cookie(cred);
                        }

                        if (idJson && idJson != "null" && idJson.length > 4) {
                            idObject = JSON.parse(idJson);
                            kernel.id.initialize(idObject);
                        } else {
                            // console.log("didn't find anything to load :(");
                        }
                    }

                    function storeCredentials() {
                        // make sure there are some credentials to persist
                        if (kernel.id.credentials.length === 0) {
                            return;
                        }

                        // serialize the ID manager state to a string
                        var idString = JSON.stringify(kernel.id.toJson());
                        // store it client side
                        if (supports_local_storage()) {
                            // use local storage
                            window.localStorage.setItem(cred, idString);
                            // console.log("wrote to local storage");
                        } else {
                            // use a cookie
                            cookie(cred, idString, {
                                expires : 1
                            });
                            // console.log("wrote a cookie :-/");
                        }
                    }

                    function supports_local_storage() {
                        try {
                            return "localStorage" in window && window["localStorage"] !== null;
                        } catch( e ) {
                            return false;
                        }
                    }

                    });
                });
    </script>
  </head>
  <body class="claro">

    <div id="mapDiv">
      <div id="bottomPanel">
<!--
        <div id="timeInfo">
          <div>Hugoton Gas Field Wells from <span id="daterange">1921 to 2009</span> (Completion date)</div>

          <div id="timeSliderDiv"></div>
        </div>-->
      </div>
    </div>
        	<div>TEST</div>
      	<div id="charts">
      		<div id="chartThreePlusDose"></div>
      	</div>
</body>
</html>
